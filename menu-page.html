<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Menu - Online Food Ordering App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Hamburger favicon -->
    <link
      rel="icon"
      type="image/png"
      href="https://cdn-icons-png.flaticon.com/512/3075/3075977.png"
    />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <header class="bg-blue-600 py-6 shadow relative">
      <div
        class="max-w-5xl mx-auto flex flex-col sm:flex-row items-center justify-between px-4"
      >
        <h1
          class="text-2xl sm:text-3xl text-white font-extrabold text-center sm:text-left mb-4 sm:mb-0"
        >
          Online Food Ordering App - Menu
        </h1>
        <div class="flex items-center space-x-2">
          <!-- Merged Cart Toggle & Badge -->
          <button
            id="toggle-cart-btn"
            class="relative bg-white text-blue-700 font-semibold px-3 py-1 rounded shadow ml-2 hover:bg-blue-100 transition flex items-center"
            title="Show/Hide Cart"
          >
            <svg
              class="w-7 h-7 text-blue-700 mr-1"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-1.35 2.7A2 2 0 0 0 7.48 19h9.04a2 2 0 0 0 1.83-1.3L21 13M7 13V6a1 1 0 0 1 1-1h9a1 1 0 0 1 1 1v7"
              ></path>
            </svg>
            <span class="hidden sm:inline">Cart</span>
            <span
              id="cart-badge"
              class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full"
              >0</span
            >
          </button>
          <span id="cart-total" class="text-white font-semibold text-lg"
            >$0.00</span
          >
          <span
            id="logged-in-user"
            class="bg-white text-blue-700 font-semibold px-3 py-1 rounded shadow ml-2"
          ></span>
          <button
            id="logout-btn"
            class="ml-2 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded font-semibold transition"
          >
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Cart Sidebar -->
    <div
      id="cart-sidebar"
      class="fixed top-0 right-0 h-full w-80 bg-white shadow-lg border-l border-gray-200 z-50 transform translate-x-full transition-transform duration-300 flex flex-col"
      style="max-width: 90vw"
    >
      <div class="flex items-center justify-between p-4 border-b">
        <h2 class="text-xl font-bold">Your Cart</h2>
        <button
          id="close-cart-btn"
          class="text-gray-500 hover:text-red-500 text-2xl font-bold"
        >
          &times;
        </button>
      </div>
      <div id="cart-items" class="flex-1 overflow-y-auto p-4"></div>
      <div class="p-4 border-t">
        <span class="font-semibold">Total: </span>
        <span id="cart-sidebar-total" class="font-bold text-blue-700"
          >$0.00</span
        >
      </div>
    </div>

    <main class="max-w-3xl mx-auto mt-10 p-6 bg-white rounded-lg shadow">
      <h2 class="text-2xl font-bold mb-6 text-gray-800">Our Menu</h2>
      <div
        id="menu-list"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8"
      ></div>
    </main>
    <script>
      // Redirect to login.html if not logged in
      const username = localStorage.getItem("username");
      if (!username) {
        window.location.href = "login.html";
      } else {
        document.getElementById(
          "logged-in-user"
        ).textContent = `Logged in as: ${username}`;
      }

      // Logout button functionality
      document
        .getElementById("logout-btn")
        .addEventListener("click", function () {
          localStorage.removeItem("username");
          window.location.href = "login.html";
        });

      // Cart sidebar toggle logic
      const cartSidebar = document.getElementById("cart-sidebar");
      const toggleCartBtn = document.getElementById("toggle-cart-btn");
      const closeCartBtn = document.getElementById("close-cart-btn");

      toggleCartBtn.addEventListener("click", () => {
        cartSidebar.classList.toggle("translate-x-full");
        renderCartSidebar(); // Always refresh cart when opened
      });
      closeCartBtn.addEventListener("click", () => {
        cartSidebar.classList.add("translate-x-full");
      });

      // Helper: Get cart from localStorage
      function getCart() {
        return JSON.parse(localStorage.getItem("cart")) || [];
      }

      // Helper: Save cart to localStorage
      function saveCart(cart) {
        localStorage.setItem("cart", JSON.stringify(cart));
      }

      // Update cart badge and total
      function updateCartBadge() {
        const badge = document.getElementById("cart-badge");
        const total = document.getElementById("cart-total");
        if (!badge || !total) return;
        const cart = getCart();
        let totalQty = 0;
        let totalPrice = 0;
        if (cart && Array.isArray(cart) && cart.length > 0) {
          totalQty = cart.reduce((sum, item) => sum + item.quantity, 0);
          totalPrice = cart.reduce(
            (sum, item) => sum + item.quantity * item.price,
            0
          );
        }
        badge.textContent = totalQty;
        total.textContent = `$${totalPrice.toFixed(2)}`;
      }

      // Render cart sidebar items with quantity controls and delete
      function renderCartSidebar() {
        const cart = getCart();
        const cartItemsDiv = document.getElementById("cart-items");
        const cartSidebarTotal = document.getElementById("cart-sidebar-total");
        if (!cartItemsDiv || !cartSidebarTotal) return;

        if (!cart.length) {
          cartItemsDiv.innerHTML = `<p class="text-gray-500 text-center mt-8">Your cart is empty.</p>`;
          cartSidebarTotal.textContent = "$0.00";
          return;
        }

        let total = 0;
        cartItemsDiv.innerHTML = cart
          .map((item, idx) => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;
            return `
                <div class="flex items-center justify-between mb-4" data-cart-idx="${idx}">
                  <div class="flex items-center space-x-3">
                    <img
                      src="${item.image}"
                      alt="${item.name}"
                      class="w-12 h-12 object-cover rounded shadow"
                    />
                    <div>
                      <div class="font-semibold">${item.name}</div>
                      <div class="flex items-center space-x-2 mt-1">
                        <button class="decrease-qty px-2 py-0.5 bg-gray-200 rounded hover:bg-gray-300 text-lg font-bold" title="Decrease quantity">-</button>
                        <input type="number" min="1" value="${
                          item.quantity
                        }" class="cart-qty-input w-12 text-center border rounded" />
                        <button class="increase-qty px-2 py-0.5 bg-gray-200 rounded hover:bg-gray-300 text-lg font-bold" title="Increase quantity">+</button>
                      </div>
                    </div>
                  </div>
                  <div class="flex flex-col items-end">
                    <div class="text-blue-700 font-bold mb-1">$${itemTotal.toFixed(
                      2
                    )}</div>
                    <button class="delete-cart-item text-red-500 hover:text-red-700 text-sm" title="Remove item">Remove</button>
                  </div>
                </div>
              `;
          })
          .join("");
        cartSidebarTotal.textContent = `$${total.toFixed(2)}`;

        // Add event listeners for quantity and delete buttons
        document
          .querySelectorAll("#cart-items .decrease-qty")
          .forEach((btn) => {
            btn.addEventListener("click", function () {
              const idx =
                this.closest("[data-cart-idx]").getAttribute("data-cart-idx");
              let cart = getCart();
              if (cart[idx].quantity > 1) {
                cart[idx].quantity -= 1;
                saveCart(cart);
                updateCartBadge();
                renderCartSidebar();
              }
            });
          });

        document
          .querySelectorAll("#cart-items .increase-qty")
          .forEach((btn) => {
            btn.addEventListener("click", function () {
              const idx =
                this.closest("[data-cart-idx]").getAttribute("data-cart-idx");
              let cart = getCart();
              cart[idx].quantity += 1;
              saveCart(cart);
              updateCartBadge();
              renderCartSidebar();
            });
          });

        document
          .querySelectorAll("#cart-items .cart-qty-input")
          .forEach((input) => {
            input.addEventListener("change", function () {
              const idx =
                this.closest("[data-cart-idx]").getAttribute("data-cart-idx");
              let cart = getCart();
              let val = parseInt(this.value);
              if (isNaN(val) || val < 1) val = 1;
              cart[idx].quantity = val;
              saveCart(cart);
              updateCartBadge();
              renderCartSidebar();
            });
          });

        document
          .querySelectorAll("#cart-items .delete-cart-item")
          .forEach((btn) => {
            btn.addEventListener("click", function () {
              const idx =
                this.closest("[data-cart-idx]").getAttribute("data-cart-idx");
              let cart = getCart();
              cart.splice(idx, 1);
              saveCart(cart);
              updateCartBadge();
              renderCartSidebar();
            });
          });
      }

      // Add to cart logic
      function addToCart(item) {
        let cart = getCart();
        const existing = cart.find((cartItem) => cartItem.id === item.id);
        if (existing) {
          existing.quantity += 1;
        } else {
          cart.push({ ...item, quantity: 1 });
        }
        saveCart(cart);
        updateCartBadge();
        renderCartSidebar();
      }

      fetch("menu-items.json")
        .then((response) => response.json())
        .then((data) => {
          const menuList = document.getElementById("menu-list");
          menuList.innerHTML = data
            .map(
              (item, idx) => `
          <div class="bg-gray-100 rounded-lg shadow p-4 flex flex-col items-center">
            <img src="${item.image}" alt="${
                item.name
              }" class="w-32 h-32 object-cover rounded mb-4 shadow" />
            <h3 class="text-xl font-semibold mb-1">${item.name}</h3>
            <p class="text-gray-600 text-center mb-2">${item.description}</p>
            <div class="flex items-center mb-2">
              <span class="text-blue-600 font-bold text-lg mr-2">$${item.price.toFixed(
                2
              )}</span>
            </div>
            <div class="flex items-center mb-4">
              <span class="text-yellow-400 mr-1">&#9733;</span>
              <span class="text-gray-700">${
                item.rating ? item.rating : "4.5"
              }</span>
            </div>
            <button
              class="add-to-cart-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-semibold transition"
              data-idx="${idx}"
            >
              Add to Cart
            </button>
          </div>
        `
            )
            .join("");

          // Add event listeners to all "Add to Cart" buttons
          document.querySelectorAll(".add-to-cart-btn").forEach((btn) => {
            btn.addEventListener("click", function () {
              const itemIdx = parseInt(this.getAttribute("data-idx"));
              const itemToAdd = data[itemIdx];
              addToCart(itemToAdd);
              this.textContent = "Added!";
              setTimeout(() => {
                this.textContent = "Add to Cart";
              }, 800);
            });
          });

          // Initialize cart badge and sidebar on page load
          updateCartBadge();
          renderCartSidebar();
        });

      // Also update cart badge and sidebar on page load in case cart already exists
      updateCartBadge();
      renderCartSidebar();
    </script>
  </body>
</html>
